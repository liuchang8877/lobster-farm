<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>å®¡æ ¸ç®¡ç† v20260227</title>
  <style>
    body { font-family: sans-serif; background: #FFF8F0; margin: 0; }
    .login { padding: 100px; text-align: center; }
    .login input { padding: 10px; font-size: 16px; width: 200px; margin-bottom: 10px; }
    .login button { padding: 10px 30px; font-size: 16px; background: #FF7B6B; color: white; border: none; border-radius: 5px; cursor: pointer; }
    .admin { display: none; }
    .header { background: #FF7B6B; color: white; padding: 20px; display: flex; justify-content: space-between; }
    .header button { background: rgba(255,255,255,0.3); border: none; color: white; padding: 8px 16px; border-radius: 5px; cursor: pointer; }
    .container { max-width: 800px; margin: 20px auto; padding: 20px; }
    .stats { display: flex; gap: 20px; margin-bottom: 30px; }
    .stat { flex: 1; background: white; padding: 20px; border-radius: 10px; text-align: center; }
    .stat-num { font-size: 30px; font-weight: bold; color: #FF7B6B; }
    .tabs { display: flex; gap: 10px; margin-bottom: 20px; }
    .tab { padding: 10px 20px; background: white; border: none; border-radius: 20px; cursor: pointer; }
    .tab.active { background: #FF7B6B; color: white; }
    .list { display: none; }
    .list.active { display: block; }
    .card { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; }
    .card h3 { margin: 0 0 10px; color: #8B6B4F; }
    .card p { color: #ccc; margin: 0 0 10px; }
    .btn { padding: 8px 16px; border: none; border-radius: 5px; cursor: pointer; margin-right: 10px; }
    .btn-a { background: #4CAF50; color: white; }
    .btn-r { background: #f44336; color: white; }
  </style>
</head>
<body>
  <!-- ç™»å½• -->
  <div class="login" id="loginDiv">
    <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
    <input type="password" id="pwd" placeholder="è¯·è¾“å…¥å¯†ç ">
    <br>
    <button id="loginBtn">ç™»å½•</button>
    <p id="err" style="color:red;"></p>
    <p style="color:#ccc;font-size:12px;">v20260227-3</p>
  </div>
  
  <!-- åå° -->
  <div class="admin" id="adminDiv">
    <div class="header">
      <h2>ğŸ¦ å®¡æ ¸ç®¡ç†ä¸­å¿ƒ v3</h2>
      <button onclick="logout()">é€€å‡º</button>
    </div>
    <div class="container">
      <div class="stats">
        <div class="stat"><div class="stat-num" id="p0">-</div><div>å¾…å®¡æ ¸</div></div>
        <div class="stat"><div class="stat-num" id="p1">-</div><div>å·²é€šè¿‡</div></div>
        <div class="stat"><div class="stat-num" id="p2">-</div><div>å·²æ‹’ç»</div></div>
      </div>
      <div class="tabs">
        <button class="tab active" id="tab0" onclick="show(0)">å¾…å®¡æ ¸</button>
        <button class="tab" id="tab1" onclick="show(1)">å·²é€šè¿‡</button>
        <button class="tab" id="tab2" onclick="show(2)">å·²æ‹’ç»</button>
      </div>
      <div class="list active" id="list0">åŠ è½½ä¸­...</div>
      <div class="list" id="list1"></div>
      <div class="list" id="list2"></div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2?v=20260227"></script>
  <script>
    console.log('v20260227-3 loaded');
    
    var supabase = window.supabase.createClient(
      'https://thpamcdbcfnmhvnmvhtc.supabase.co',
      'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InRocGFtY2RiY2ZubWh2bm12aHRjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxNTg5MTIsImV4cCI6MjA4NzczNDkxMn0.7Mgl8AE6au-ICi22U8R7u2MFQqKyd1EP0-a-PsC6c2w'
    );
    console.log('Supabase client created');
    
    // ç™»å½•æŒ‰é’®
    var loginBtn = document.getElementById('loginBtn');
    loginBtn.onclick = function() {
      console.log('login clicked');
      var pwd = document.getElementById('pwd').value;
      console.log('password:', pwd);
      if (pwd === 'lobster2026') {
        console.log('password correct');
        localStorage.setItem('admin', '1');
        document.getElementById('loginDiv').style.display = 'none';
        document.getElementById('adminDiv').style.display = 'block';
        load();
      } else {
        console.log('password wrong');
        document.getElementById('err').innerText = 'å¯†ç é”™è¯¯';
      }
    };
    
    // å›è½¦ç™»å½•
    document.getElementById('pwd').onkeyup = function(e) {
      if (e.key === 'Enter') document.getElementById('loginBtn').onclick();
    };
    
    // æ£€æŸ¥ç™»å½•
    console.log('check login:', localStorage.getItem('admin'));
    if (localStorage.getItem('admin') === '1') {
      document.getElementById('loginDiv').style.display = 'none';
      document.getElementById('adminDiv').style.display = 'block';
      load();
    }
    
    function logout() {
      localStorage.removeItem('admin');
      location.reload();
    }
    
    function show(n) {
      for (var i = 0; i < 3; i++) {
        document.getElementById('tab' + i).className = 'tab' + (i === n ? ' active' : '');
        document.getElementById('list' + i).className = 'list' + (i === n ? ' active' : '');
      }
    }
    
    async function load() {
      console.log('loading data...');
      var s = ['pending', 'approved', 'rejected'];
      var tables = [
        { name: 'breeds', kind: 'å“ç§' },
        { name: 'skills', kind: 'æŠ€èƒ½' },
        { name: 'scenes', kind: 'åœºæ™¯' }
      ];
      try {
        var countResults = await Promise.all(s.map(function(st) {
          return Promise.all(tables.map(function(t) {
            return supabase.from(t.name).select('*', { count: 'exact', head: true }).eq('status', st);
          }));
        }));
        var counts = countResults.map(function(group) {
          return group.reduce(function(sum, r) { return sum + (r.count || 0); }, 0);
        });
        console.log('counts:', counts);
        
        for (var i = 0; i < 3; i++) {
          document.getElementById('p' + i).innerText = counts[i] || 0;
        }
        
        var data = await Promise.all(s.map(function(st) {
          return Promise.all(tables.map(function(t) {
            return supabase.from(t.name).select('*').eq('status', st).order('created_at', { ascending: false }).limit(20);
          }));
        }));
        console.log('data loaded:', data.length);
        
        for (var i = 0; i < 3; i++) {
          var merged = [];
          for (var k = 0; k < tables.length; k++) {
            var rows = (data[i][k].data || []).map(function(item) {
              item._table = tables[k].name;
              item._kind = tables[k].kind;
              return item;
            });
            merged = merged.concat(rows);
          }
          merged.sort(function(a, b) {
            return new Date(b.created_at || 0) - new Date(a.created_at || 0);
          });
          var list = merged.slice(0, 20);
          var html = '';
          if (list.length === 0) {
            html = '<p style="text-align:center;color:#ccc;padding:40px;">æš‚æ— å†…å®¹</p>';
          } else {
            for (var j = 0; j < list.length; j++) {
              var item = list[j];
              var btns = item.status === 'pending' ? 
                '<button class="btn btn-a" onclick="action(\'' + item.id + '\',\'approved\',\'' + item._table + '\')">âœ… é€šè¿‡</button>' +
                '<button class="btn btn-r" onclick="action(\'' + item.id + '\',\'rejected\',\'' + item._table + '\')">âŒ æ‹’ç»</button>' : '';
              var metaLine = item.meta ? ('<p>ç‰¹ç‚¹ï¼š' + item.meta + '</p>') : '';
              var badgeLine = item.badge ? ('<p>æ ‡ç­¾ï¼š' + item.badge + '</p>') : '';
              html += '<div class="card"><h3>' + item.name + '</h3><p>ç±»å‹ï¼š' + item._kind + '</p><p>' + (item.description || 'æš‚æ— æè¿°') + '</p>' + metaLine + badgeLine + btns + '</div>';
            }
          }
          document.getElementById('list' + i).innerHTML = html;
        }
      } catch(e) {
        console.error('error:', e);
        alert('åŠ è½½å¤±è´¥: ' + e.message);
      }
    }
    
    async function action(id, status, table) {
      if (status === 'rejected') {
        var reason = prompt('è¯·è¾“å…¥æ‹’ç»åŸå› ï¼š');
        if (!reason) return;
        if (table === 'skills') {
          await supabase.from(table).update({ status: 'rejected', status_message: reason }).eq('id', id);
        } else {
          await supabase.from(table).update({ status: 'rejected' }).eq('id', id);
        }
      } else {
        if (!confirm('ç¡®è®¤é€šè¿‡ï¼Ÿ')) return;
        await supabase.from(table).update({ status: 'approved' }).eq('id', id);
      }
      alert(status === 'approved' ? 'âœ… å·²é€šè¿‡' : 'âŒ å·²æ‹’ç»');
      load();
    }
  </script>
</body>
</html>
